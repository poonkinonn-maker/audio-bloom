<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic Engine - Pro Visualizer</title>
    <style>
        /* --- æ²‰æµ¸å¼ UI è®¾è®¡ --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

        :root {
            --accent: #00f3ff;
            --panel-bg: rgba(18, 18, 24, 0.75);
            --text-main: #ffffff;
            --text-sub: #a0a0b0;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #000;
            font-family: 'Inter', sans-serif;
            user-select: none;
        }

        /* å±‚çº§ç®¡ç† */
        #layer-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; }
        #layer-vignette { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: radial-gradient(circle, transparent 40%, #000 100%); pointer-events: none; }
        #layer-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        #layer-ui { position: absolute; z-index: 10; pointer-events: none; width: 100%; height: 100%; }

        /* èƒŒæ™¯åª’ä½“ */
        #bg-media {
            width: 100%; height: 100%; object-fit: cover;
            transform: scale(1.05); /* é¢„ç•™ç¼©æ”¾ç©ºé—´ */
            transition: filter 0.2s ease;
        }
        
        /* å¯åŠ¨é®ç½© */
        #overlay-start {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease;
        }
        .start-btn {
            padding: 15px 40px; border: 1px solid var(--accent); background: transparent;
            color: var(--accent); font-size: 1.2rem; letter-spacing: 2px;
            cursor: pointer; transition: all 0.3s; text-transform: uppercase;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
            pointer-events: auto;
        }
        .start-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 30px var(--accent); }

        /* æ§åˆ¶é¢æ¿ (ä»¿ Wallpaper Engine å³ä¾§æ ) */
        #settings-panel {
            position: absolute; right: 0; top: 0; bottom: 0; width: 320px;
            background: var(--panel-bg); backdrop-filter: blur(15px);
            border-left: 1px solid rgba(255,255,255,0.08);
            transform: translateX(320px); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 20px; box-sizing: border-box; overflow-y: auto; pointer-events: auto;
            display: flex; flex-direction: column; gap: 20px;
        }
        #settings-panel.active { transform: translateX(0); }

        /* è§¦å‘æŒ‰é’® */
        #btn-toggle-settings {
            position: absolute; top: 20px; right: 20px; pointer-events: auto;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2); color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20; transition: all 0.2s;
        }
        #btn-toggle-settings:hover { background: rgba(255,255,255,0.2); }

        /* UI ç»„ä»¶æ ·å¼ */
        h3 { margin: 0; color: var(--text-main); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 10px; }
        .control-item { margin-bottom: 15px; }
        .control-label { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sub); margin-bottom: 6px; }
        
        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px; background: var(--accent); border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px var(--accent);
        }
        
        select {
            width: 100%; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; outline: none;
        }

        .file-upload {
            position: relative; overflow: hidden; display: inline-block; width: 100%;
            background: rgba(255,255,255,0.05); padding: 10px; text-align: center;
            border: 1px dashed rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; color: var(--text-sub); font-size: 12px;
        }
        .file-upload:hover { border-color: var(--accent); color: var(--accent); }
        .file-upload input { position: absolute; top:0; left:0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        /* Logo / Clock åŒºåŸŸ */
        #center-info {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; z-index: 1; pointer-events: none; opacity: 0.8;
        }
        #clock { font-size: 4rem; font-weight: 200; letter-spacing: -2px; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #track-info { font-size: 0.9rem; color: var(--accent); text-transform: uppercase; letter-spacing: 3px; margin-top: 5px; }

    </style>
</head>
<body>

    <!-- å¯åŠ¨å±‚ -->
    <div id="overlay-start">
        <h1 style="color:white; font-weight:300; letter-spacing:5px; margin-bottom:30px;">SONIC ENGINE</h1>
        <button class="start-btn" onclick="app.init()">INITIALIZE SYSTEM</button>
    </div>

    <!-- èƒŒæ™¯å±‚ -->
    <div id="layer-bg">
        <video id="bg-media" loop muted playsinline autoplay></video>
        <div id="bg-placeholder" style="width:100%; height:100%; background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);"></div>
    </div>
    
    <!-- æš—è§’å±‚ (Vignette) -->
    <div id="layer-vignette"></div>

    <!-- æ ¸å¿ƒç”»å¸ƒ -->
    <canvas id="layer-canvas"></canvas>

    <!-- UI å±‚ -->
    <div id="layer-ui">
        <div id="center-info">
            <div id="clock">00:00</div>
            <div id="track-info">AUDIO VISUALIZER</div>
        </div>

        <button id="btn-toggle-settings">âš™ï¸</button>

        <div id="settings-panel">
            <h3>Visual Style</h3>
            <div class="control-item">
                <div class="control-label"><span>Mode</span></div>
                <select id="opt-mode" onchange="app.config.mode = this.value">
                    <option value="circle">Cyber Ring (ç¯å½¢)</option>
                    <option value="line">Neon Horizon (åœ°å¹³çº¿)</option>
                    <option value="wave">Fluid Wave (æµä½“)</option>
                </select>
            </div>
            
            <div class="control-item">
                <div class="control-label"><span>Color Scheme</span></div>
                <select id="opt-color" onchange="app.setTheme(this.value)">
                    <option value="cyan">Cyber Cyan</option>
                    <option value="fire">Hell Fire</option>
                    <option value="purple">Neon Eva</option>
                    <option value="gold">Luxury Gold</option>
                    <option value="rgb">RGB Gamer</option>
                </select>
            </div>

            <div class="control-item">
                <div class="control-label"><span>Glow Strength (å…‰æ™•)</span></div>
                <input type="range" min="0" max="50" value="20" oninput="app.config.glow = this.value">
            </div>

            <h3>Reactivity</h3>
            <div class="control-item">
                <div class="control-label"><span>Sensitivity (çµæ•åº¦)</span></div>
                <input type="range" min="0.5" max="3" step="0.1" value="1.5" oninput="app.config.sensitivity = this.value">
            </div>
            <div class="control-item">
                <div class="control-label"><span>Background Pulse (èƒŒæ™¯éœ‡åŠ¨)</span></div>
                <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="app.config.bgPulse = this.value">
            </div>
             <div class="control-item">
                <div class="control-label"><span>Particles (ç²’å­æ•°é‡)</span></div>
                <input type="range" min="0" max="200" step="10" value="100" oninput="app.config.particleCount = parseInt(this.value)">
            </div>

            <h3>Background</h3>
            <div class="control-item">
                <div class="file-upload">
                    <span>ğŸ“ Upload Image / Video</span>
                    <input type="file" accept="image/*,video/*" onchange="app.handleFileUpload(this)">
                </div>
            </div>
            <div class="control-item">
                <div class="control-label"><span>Blur (æ¨¡ç³Š)</span></div>
                <input type="range" min="0" max="30" value="0" oninput="app.updateBgBlur(this.value)">
            </div>
            <div class="control-item">
                <div class="control-label"><span>Brightness (äº®åº¦)</span></div>
                <input type="range" min="0" max="100" value="60" oninput="app.updateBgDim(this.value)">
            </div>
        </div>
    </div>

    <script>
        /**
         * SONIC ENGINE - Core Logic
         * åŒ…å«éŸ³é¢‘åˆ†æã€ç²’å­ç³»ç»Ÿã€é«˜æ€§èƒ½æ¸²æŸ“ç®¡çº¿
         */
        const app = {
            config: {
                mode: 'circle', // circle, line, wave
                sensitivity: 1.5,
                glow: 20,
                bgPulse: 0.5,
                particleCount: 100,
                theme: { h: 180, s: 100, l: 50 }, // HSL
                isRGB: false
            },
            state: {
                audioCtx: null,
                analyser: null,
                dataArray: null,
                bass: 0,
                mid: 0,
                high: 0,
                isPlaying: false
            },
            ui: {
                canvas: document.getElementById('layer-canvas'),
                ctx: document.getElementById('layer-canvas').getContext('2d'),
                bgMedia: document.getElementById('bg-media'),
                bgPlaceholder: document.getElementById('bg-placeholder'),
                panel: document.getElementById('settings-panel')
            },
            particles: [],

            // åˆå§‹åŒ–
            init: async function() {
                try {
                    // Audio Setup
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.state.audioCtx = new AudioContext();
                    this.state.analyser = this.state.audioCtx.createAnalyser();
                    this.state.analyser.fftSize = 2048;
                    this.state.analyser.smoothingTimeConstant = 0.85; // æ›´æŸ”å’Œçš„å¹³æ»‘

                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const source = this.state.audioCtx.createMediaStreamSource(stream);
                    source.connect(this.state.analyser);

                    const bufferLength = this.state.analyser.frequencyBinCount;
                    this.state.dataArray = new Uint8Array(bufferLength);

                    // UI Cleanup
                    document.getElementById('overlay-start').style.opacity = 0;
                    setTimeout(() => document.getElementById('overlay-start').remove(), 600);
                    this.state.isPlaying = true;

                    // Resize & Events
                    this.resize();
                    window.addEventListener('resize', () => this.resize());
                    this.initClock();
                    
                    // Start Loop
                    this.loop();

                } catch (e) {
                    alert("éº¦å…‹é£æˆæƒå¤±è´¥æˆ–æµè§ˆå™¨ä¸æ”¯æŒ Web Audio APIã€‚\nError: " + e.message);
                }
            },

            // æ¸²æŸ“ä¸»å¾ªç¯
            loop: function() {
                if (!this.state.isPlaying) return;
                requestAnimationFrame(() => this.loop());

                const { ctx, canvas } = this.ui;
                const { width, height } = canvas;

                // 1. è·å–éŸ³é¢‘æ•°æ®
                this.state.analyser.getByteFrequencyData(this.state.dataArray);
                this.analyzeAudioFeatures(); // è®¡ç®—ä½ä¸­é«˜é¢‘åˆ†é‡

                // 2. æ¸…é™¤ç”»å¸ƒ (ä¿ç•™å¾®å¼±æ‹–å°¾ä»¥å½¢æˆåŠ¨æ€æ¨¡ç³Šæ„Ÿ? å¦ï¼Œè¿™é‡Œè¿½æ±‚æ¸…æ™°ï¼Œå…¨æ¸…)
                ctx.clearRect(0, 0, width, height);

                // 3. åº”ç”¨åŠ¨æ€èƒŒæ™¯æ•ˆæœ (Zoom on Bass)
                this.applyBackgroundReaction();

                // 4. ç»˜åˆ¶ç²’å­
                this.updateAndDrawParticles();

                // 5. ç»˜åˆ¶å¯è§†åŒ–ä¸»ä½“
                ctx.save();
                
                // è®¾ç½®å‘å…‰æ•ˆæœ
                ctx.shadowBlur = this.config.glow;
                ctx.shadowColor = this.getCurrentColor();
                ctx.strokeStyle = this.getCurrentColor();
                ctx.fillStyle = this.getCurrentColor();
                ctx.globalCompositeOperation = 'lighter'; // å…³é”®ï¼šé¢œè‰²å åŠ å˜äº®

                if (this.config.mode === 'circle') this.drawCircleViz(width/2, height/2);
                else if (this.config.mode === 'line') this.drawLineViz(width, height);
                else if (this.config.mode === 'wave') this.drawFluidWave(width, height);

                ctx.restore();

                // RGB æ¨¡å¼ä¸‹è‡ªåŠ¨å˜è‰²
                if (this.config.isRGB) {
                    this.config.theme.h = (this.config.theme.h + 0.5) % 360;
                }
            },

            // éŸ³é¢‘ç‰¹å¾æå– (ç®€å•çš„åˆ†é¢‘)
            analyzeAudioFeatures: function() {
                const data = this.state.dataArray;
                const len = data.length;
                
                // Bass: 0 ~ 50Hz (Approx first 20 bins)
                let bassSum = 0;
                for(let i=0; i<20; i++) bassSum += data[i];
                this.state.bass = (bassSum / 20) / 255; // 0.0 - 1.0

                // Mid: 
                let midSum = 0;
                for(let i=20; i<200; i++) midSum += data[i];
                this.state.mid = (midSum / 180) / 255;
            },

            // èƒŒæ™¯ååº”é€»è¾‘
            applyBackgroundReaction: function() {
                const scale = 1.0 + (this.state.bass * 0.1 * this.config.bgPulse);
                // ä½¿ç”¨ CSS transform å®ç°é«˜æ€§èƒ½ç¼©æ”¾
                this.ui.bgMedia.style.transform = `scale(${Math.max(1.05, 1.05 * scale)})`;
                this.ui.bgPlaceholder.style.transform = `scale(${Math.max(1.05, 1.05 * scale)})`;
            },

            // --- å¯è§†åŒ–ç®—æ³• ---

            // 1. Cyber Ring (ä»¿é’¢é“ä¾ ååº”å †/å…‰ç¯)
            drawCircleViz: function(cx, cy) {
                const { ctx } = this.ui;
                const radius = Math.min(cx, cy) * 0.4 + (this.state.bass * 50);
                const bars = 180; // æ›´å¤šç»†èŠ‚
                const step = Math.floor(this.state.dataArray.length / bars);

                ctx.beginPath();
                for (let i = 0; i < bars; i++) {
                    const val = this.state.dataArray[i * step];
                    const barH = (val * this.config.sensitivity * 0.8) + 2; 
                    const rad = (i / bars) * Math.PI * 2 - Math.PI/2; // ä»é¡¶éƒ¨å¼€å§‹

                    // æåæ ‡è®¡ç®—
                    const x1 = cx + Math.cos(rad) * radius;
                    const y1 = cy + Math.sin(rad) * radius;
                    const x2 = cx + Math.cos(rad) * (radius + barH);
                    const y2 = cy + Math.sin(rad) * (radius + barH);

                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                }
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.stroke();

                // å†…åœˆè£…é¥°çº¿
                ctx.beginPath();
                ctx.arc(cx, cy, radius - 10, 0, Math.PI*2);
                ctx.lineWidth = 1;
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.stroke();
            },

            // 2. Neon Horizon (ç»å…¸æŸ±çŠ¶ + é•œåƒ)
            drawLineViz: function(w, h) {
                const { ctx } = this.ui;
                const bars = 128;
                const barW = w / bars;
                
                for (let i = 0; i < bars; i++) {
                    const val = this.state.dataArray[i * 4]; // é‡‡æ ·ç¨å¾®ç¨€ç–ä¸€ç‚¹
                    const barH = val * this.config.sensitivity * (h/400) * 100;
                    
                    const x = i * barW;
                    const centerY = h - 100;

                    // ç»˜åˆ¶çŸ©å½¢
                    ctx.fillRect(x, centerY - barH, barW - 1, barH);
                    
                    // å€’å½± (é€æ˜åº¦é™ä½)
                    ctx.fillStyle = this.getCurrentColor(0.3);
                    ctx.fillRect(x, centerY, barW - 1, barH * 0.5);
                    ctx.fillStyle = this.getCurrentColor(1); // æ¢å¤
                }
            },

            // 3. Fluid Wave (æ­£å¼¦æ³¢å åŠ )
            drawFluidWave: function(w, h) {
                const { ctx } = this.ui;
                ctx.beginPath();
                ctx.lineWidth = 3;
                
                const sliceW = w / this.state.dataArray.length;
                let x = 0;
                
                // ä¸ºäº†å¹³æ»‘ï¼Œæˆ‘ä»¬ç”»ä¸‰æ¡çº¿
                for (let j = 1; j <= 3; j++) {
                    ctx.beginPath();
                    let offset = j * 50; // åç§»
                    ctx.strokeStyle = this.getCurrentColor(1.0 - (j*0.2)); // æ¸éš

                    for(let i = 0; i < this.state.dataArray.length; i += 10) {
                        const v = this.state.dataArray[i] / 128.0;
                        const y = (h/2) + Math.sin(i/20 + Date.now()/1000 * j) * (v * 100 * this.config.sensitivity);
                        
                        if(i===0) ctx.moveTo(x, y);
                        else ctx.lineTo(i * sliceW * 10, y);
                    }
                    ctx.stroke();
                }
            },

            // --- ç²’å­ç³»ç»Ÿ ---
            updateAndDrawParticles: function() {
                const { ctx, canvas } = this.ui;
                const cx = canvas.width / 2;
                const cy = canvas.height / 2;

                // 1. å¦‚æœä½éŸ³å¼ºåŠ²ï¼Œå‘å°„æ–°ç²’å­
                if (this.state.bass > 0.7 && this.particles.length < this.config.particleCount) {
                    for(let k=0; k<5; k++) {
                        this.particles.push({
                            x: cx, y: cy,
                            vx: (Math.random() - 0.5) * 10,
                            vy: (Math.random() - 0.5) * 10,
                            life: 1.0,
                            size: Math.random() * 3 + 1
                        });
                    }
                }

                // 2. æ›´æ–°å¹¶ç»˜åˆ¶
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    let p = this.particles[i];
                    
                    // ç‰©ç†ç§»åŠ¨
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life -= 0.02; // è¡°å‡
                    
                    if (p.life <= 0) {
                        this.particles.splice(i, 1);
                        continue;
                    }

                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                    // ç²’å­é¢œè‰²åç™½ï¼Œå¸¦æœ‰ä¸»è‰²è°ƒå…‰æ™•
                    ctx.fillStyle = `rgba(255, 255, 255, ${p.life})`;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = this.getCurrentColor();
                    ctx.fill();
                }
            },

            // --- è¾…åŠ©åŠŸèƒ½ ---
            resize: function() {
                this.ui.canvas.width = window.innerWidth;
                this.ui.canvas.height = window.innerHeight;
            },
            
            getCurrentColor: function(alpha = 1) {
                const { h, s, l } = this.config.theme;
                return `hsla(${h}, ${s}%, ${l}%, ${alpha})`;
            },

            setTheme: function(name) {
                this.config.isRGB = false;
                switch(name) {
                    case 'cyan': this.config.theme = { h: 180, s: 100, l: 50 }; document.documentElement.style.setProperty('--accent', '#00f3ff'); break;
                    case 'fire': this.config.theme = { h: 10, s: 100, l: 50 }; document.documentElement.style.setProperty('--accent', '#ff4d00'); break;
                    case 'purple': this.config.theme = { h: 280, s: 100, l: 60 }; document.documentElement.style.setProperty('--accent', '#d500f9'); break;
                    case 'gold': this.config.theme = { h: 45, s: 100, l: 50 }; document.documentElement.style.setProperty('--accent', '#ffd700'); break;
                    case 'rgb': this.config.isRGB = true; break;
                }
            },

            handleFileUpload: function(input) {
                const file = input.files[0];
                if (!file) return;
                const url = URL.createObjectURL(file);
                
                if (file.type.startsWith('video')) {
                    this.ui.bgPlaceholder.style.display = 'none';
                    this.ui.bgMedia.style.display = 'block';
                    this.ui.bgMedia.src = url;
                    this.ui.bgMedia.play();
                } else {
                    this.ui.bgMedia.style.display = 'none';
                    this.ui.bgPlaceholder.style.display = 'block';
                    this.ui.bgPlaceholder.style.background = `url(${url}) no-repeat center center / cover`;
                }
            },

            updateBgBlur: function(val) {
                const filter = `blur(${val}px) brightness(${document.querySelector('#settings-panel input[max="100"]').value}%)`;
                this.ui.bgMedia.style.filter = filter;
                this.ui.bgPlaceholder.style.filter = filter;
            },
            
            updateBgDim: function(val) {
                const blurVal = document.querySelector('#settings-panel input[max="30"]').value;
                const filter = `blur(${blurVal}px) brightness(${val}%)`;
                this.ui.bgMedia.style.filter = filter;
                this.ui.bgPlaceholder.style.filter = filter;
            },

            initClock: function() {
                const clockEl = document.getElementById('clock');
                setInterval(() => {
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    clockEl.innerText = `${hours}:${minutes}`;
                }, 1000);
            }
        };

        // UI Toggle
        const btn = document.getElementById('btn-toggle-settings');
        const panel = document.getElementById('settings-panel');
        btn.addEventListener('click', () => {
            panel.classList.toggle('active');
        });

    </script>
</body>
</html>
